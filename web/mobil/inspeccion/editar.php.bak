<?php
	include_once 'global.php.inc';
	include_once 'db_local.php.inc';
?>

<body>
<?php
	//<body onload='getLocation()'>
	$Id = (int)($_GET["id"]);
	
	$sql="SELECT * FROM Inspeccion_RelevamientoAsignacionDetalle WHERE id='$Id'";
	$row = $db_local->query($sql)->fetch();
?>

<form name="editar" action="guardar.php" method="post" onsubmit="getLocation()">
<input type="hidden" id="id" name="id" value="<?php echo $Id; ?>" />
<input type="hidden" id="Foto" name="Foto" />

<div class="encab">
<div class="encab-izquierda">Yacaré - Inspección</div>
<div class="encab-derecha">
 <button type='submit' name='Aceptar'>Guardar</button>
 <button value='Back' onclick="parent.location='listado.php'">Cancelar</button>
</div>
</div>

<div class="barraizquierda">

<fieldset name='Domicilio'>
<legend>Calle <?php echo $row['PartidaCalleNombre']; ?> Nº <?php echo $row['PartidaCalleNumero']; ?></legend>
Sección <?php echo $row['PartidaSeccion']; ?>,
Macizo <?php echo $row['PartidaMacizo']; ?>,
Parcela <?php echo $row['PartidaParcela']; ?>
</fieldset>

<fieldset>
<legend>Incidentes</legend>
<select name='Resultado1' style="width: 360px;" required='required'>
<option value=''>Seleccione uno o más incidentes</option>
<?php
	$sql = "SELECT * FROM inspeccion_relevamientoResultado ORDER BY Grupo ASC";
	foreach ($db_local->query($sql) as $row) {
?>
<option value="<?php echo $row['Id']; ?>"><?php echo $row['Grupo']; ?>: <?php echo $row['Nombre']; ?></option>
<?php
	}
?>
</select>

<select name='Resultado2' style="width: 360px;">
<option value=''></option>
<?php
	$sql="SELECT * FROM inspeccion_relevamientoResultado ORDER BY Grupo ASC";
	foreach ($db_local->query($sql) as $row) {		
?>
<option value="<?php echo $row['Id']; ?>"><?php echo $row['Grupo']; ?>: <?php echo $row['Nombre']; ?></option>
<?php
	}
?>
</select>

<select name='Resultado3' style="width: 360px;">
<option value=''></option>
<?php
	$sql="SELECT * FROM inspeccion_relevamientoResultado ORDER BY Grupo ASC";
	foreach ($db_local->query($sql) as $row) {		
?>
<option value="<?php echo $row['Id']; ?>"><?php echo $row['Grupo']; ?>: <?php echo $row['Nombre']; ?></option>
<?php
	}
?>
</select>
</fieldset>

<?php // <p id='geo'>Haga click en el botón para obtener la ubicacion actual</p> ?>
<fieldset name='Ubicacion'>
<legend>Georeferencia</legend>
Latitud <input type='text' name='lat' id='lat' maxlength=16 size=5 readonly />, longitud <input type='text' maxlength=16 size=5 name='lon' id='lon' readonly /><br />
</fieldset>

<fieldset name='Observaciones'>
<textarea name='Obs' cols='50' rows='10' style="width: 95%" placeholder="Escriba aquí las observaciones"></textarea>
</fieldset>
</div>

<div class="contenido">

<fieldset>
<button type='button' id='snap' onclick='nuevaFoto()'>Volver a capturar</button>
<div id='video_div'><video id='video' width='800' height='600' autoplay onclick='getLocation()'></video></div><br />
<div id='canvas_div' style="display: none;"><canvas id='canvas' name='canvas' width='800' height='600' style='border: 1px'></canvas></div>
<fieldset>

</div>
</form>

<script>

function goBack() {
	window.history.back();
}

// Put event listeners into place
window.addEventListener("DOMContentLoaded", function() {
	// Grab elements, create settings, etc.
	var canvas = document.getElementById("canvas"),
		context = canvas.getContext("2d"),
		video = document.getElementById("video"),
		videoObj = { "video": true },
		canvas_div = document.getElementById("canvas_div"),
		video_div = document.getElementById("video_div"),
		errBack = function(error) {
			console.log("Video capture error: ", error.code); 
		window.location = canvas.toDataURL("image/jpg");
		};

	// Put video listeners into place
	if(navigator.getUserMedia) { // Standard
		navigator.getUserMedia(videoObj, function(stream) {
			video.src = stream;
			video.play();
		}, errBack);
	} else if(navigator.webkitGetUserMedia) { // WebKit-prefixed
		navigator.webkitGetUserMedia(videoObj, function(stream){
			video.src = window.webkitURL.createObjectURL(stream);
			video.play();
		}, errBack);
	}

	// Trigger photo take
	document.getElementById("video").addEventListener("click", function() {
		context.drawImage(video, 0, 0, 800, 600);
		var campoCanvas = document.getElementById("canvas");
		var campoFoto = campoCanvas.toDataURL();
		document.getElementById("Foto").value = campoFoto;
		video_div.style.display='none';
		canvas_div.style.display='';
							
		//window.open(campoFoto, "toDataURL() image", "width=640, height=480");
	});
}, false);

var x=document.getElementById("geo");
function getLocation() {
	if (navigator.geolocation) {
		navigator.geolocation.getCurrentPosition(showPosition);
	} else {
		x.innerHTML='Este navegador no soporta localización';
	}
}

function showPosition(position) {
	//x.innerHTML="Latitude: " + position.coords.latitude +
	//"<br>Longitude: " + position.coords.longitude;
	document.getElementById("lat").value = position.coords.latitude;
	document.getElementById("lon").value = position.coords.longitude;  
}

function nuevaFoto() {
	
	//Volver a tomar foto
	document.getElementById("snap").addEventListener("click", function() {
		video_div.style.display='';
		canvas_div.style.display='none';
	});
}
</script>

<?php
	$_SESSION['habilitado'] = 1;
?>

</body>
</html>
